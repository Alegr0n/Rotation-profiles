version: 1.0
author: Alegr0n
class: Priest
spec: Discipline
name: GodMode V3 Oracle M+
description: |
  Discipline Priest Oracle rotation for Midnight Pre-Patch.
  Optimized for M+ dungeons.
url: https://github.com/Alegr0n/Rotation-profiles/blob/main/rotation_256.yaml
entry: main

morphs:
  shadow_word_pain: purge_the_wicked

config:

  # GENERAL SETTINGS

  auto_targeting:
    label: "Auto-target if no target"
    type: checkbox
    default: true


  # DEFENSIVE COOLDOWNS

  pain_suppression_threshold:
    label: "Pain Suppression HP %"
    type: slider
    min: 10
    max: 60
    default: 40

  pain_suppression_usage:
    label: "Pain Suppression Targets"
    type: dropdown
    options:
      - label: "Tank Only"
        value: 1
      - label: "Tank & Healer"
        value: 2
      - label: "Everyone"
        value: 3
      - label: "Disabled"
        value: 0
    default: 2

  desperate_prayer_threshold:
    label: "Desperate Prayer HP %"
    type: slider
    min: 10
    max: 70
    default: 35

  power_word_barrier_members:
    label: "PW:Barrier - below 60%"
    type: slider
    min: 2
    max: 5
    default: 3

  auto_fade:
    label: "Auto Fade"
    type: checkbox
    default: false

  auto_pi:
    label: "Auto PI [Beta]"
    type: checkbox
    default: true


  # INTERRUPTS / CC

  use_psychic_scream:
    label: "Use Psychic Scream (AoE CC)"
    type: checkbox
    default: false

  # MAJOR COOLDOWNS

  evangelism_members:
    label: "Evangelism - below 80%"
    type: slider
    min: 1
    max: 5
    default: 3

  ultimate_penitence_members:
    label: "Ultimate Penit. - below 60%"
    type: slider
    min: 1
    max: 5
    default: 3

  shadowfiend_usage:
    label: "Shadowfiend Usage"
    type: dropdown
    options:
      - label: "On Cooldown"
        value: 1
      - label: "2+ members below 80%"
        value: 2
      - label: "3+ members below 70%"
        value: 3
      - label: "Manual Only"
        value: 0
    default: 2


  # ATONEMENT SPREAD

  radiance_members:
    label: "PWR - Members below 85%"
    type: slider
    min: 2
    max: 5
    default: 3

  penance_healing_threshold:
    label: "Penance Healing HP %"
    type: slider
    min: 40
    max: 90
    default: 70

  flash_heal_threshold:
    label: "Flash Heal HP %"
    type: slider
    min: 30
    max: 80
    default: 60

  # POWER WORD: SHIELD

  pws_hp_threshold:
    label: "PW:Shield HP threshold %"
    type: slider
    min: 50
    max: 90
    default: 80

  weal_and_woe_min_stacks:
    label: "Min WaW stacks for PW:S"
    type: slider
    min: 0
    max: 10
    default: 5


  # DAMAGE / OFFENSIVE

  use_shadow_word_death:
    label: "Use SW:Death"
    type: checkbox
    default: true

  maintain_dot:
    label: "Purge the Wicked/SWP"
    type: checkbox
    default: true


  # MOUSEOVER SETTINGS

  mouseover_enabled:
    label: "Enable Mouseover Healing"
    type: checkbox
    default: true

  mo_pain_suppression:
    label: "MO: Pain Suppression"
    type: checkbox
    default: true

  mo_penance:
    label: "MO: Penance"
    type: checkbox
    default: true

  mo_penance_threshold:
    label: "MO Penance HP %"
    type: slider
    min: 40
    max: 90
    default: 65

  mo_flash_heal:
    label: "MO: Flash Heal"
    type: checkbox
    default: true

  mo_flash_heal_threshold:
    label: "MO Flash Heal HP %"
    type: slider
    min: 30
    max: 90
    default: 75

  mo_purify:
    label: "MO: Dispel (Purify)"
    type: checkbox
    default: true

  mo_dot:
    label: "MO: Purge the Wicked"
    type: checkbox
    default: true


  # BUFFS

  auto_fortitude:
    label: "Auto Power Word: Fortitude"
    type: checkbox
    default: true


  # OUT OF COMBAT

  ooc_penance_threshold:
    label: "OOC Penance HP %"
    type: slider
    min: 70
    max: 100
    default: 90

  ooc_flash_heal_threshold:
    label: "OOC Flash Heal HP %"
    type: slider
    min: 50
    max: 90
    default: 70


  # UTILITY

  angelic_feather_usage:
    label: "Angelic Feather Usage"
    type: dropdown
    options:
      - label: "Disabled"
        value: 0
      - label: "Only in combat"
        value: 1
      - label: "Only out of combat"
        value: 2
      - label: "Always when moving"
        value: 3
    default: 2

  angelic_feather_movement_time:
    label: "Feather after moving"
    type: slider
    min: 0
    max: 4
    default: 2


  # TRINKETS

  trinket_usage:
    label: "Trinket Usage"
    type: dropdown
    options:
      - label: "On Cooldown"
        value: 1
      - label: "With Evangelism"
        value: 2
      - label: "When group damaged"
        value: 3
      - label: "Manual Only"
        value: 0
    default: 1

  living_silk_members:
    label: "Living Silk - Members"
    type: slider
    min: 1
    max: 5
    default: 3

  living_silk_hp:
    label: "Living Silk HP %"
    type: slider
    min: 30
    max: 80
    default: 70

variables:

  power_of_dark_side: buff.power_of_the_dark_side.up
  evangelism_window: buff.evangelism.up
  surge_of_light_active: buff.surge_of_light.up

  weal_and_woe_stacks: buff.weal_and_woe.stack
  weal_and_woe_ready: var.weal_and_woe_stacks>=config.weal_and_woe_min_stacks

  hold_penance: cooldown.penance.charges<2&cooldown.penance.full_recharge_time>4
  penance_ready: cooldown.penance.charges>=1&!var.hold_penance

  mo_friendly_valid: mouseover.exists&mouseover.alive&mouseover.friendly&mouseover.range>0&mouseover.range<=40
  mo_enemy_valid: mouseover.exists&mouseover.alive&mouseover.enemy

  use_feather: moving.time>=config.angelic_feather_movement_time&buff.angelic_feather.down&((config.angelic_feather_usage=1&player.combat)|(config.angelic_feather_usage=2&!player.combat)|(config.angelic_feather_usage=3))

  trinket1_living_silk: trinket_1.id=242393
  trinket2_living_silk: trinket_2.id=242393
  has_living_silk: var.trinket1_living_silk|var.trinket2_living_silk


lists:

  spell_queue:
    - queue_spell
  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs

  interrupts:

    - psychic_scream,if=config.use_psychic_scream&(interrupts.8y.count>=2|interrupts.8y.stun.count>=2)

  out_of_combat:

    - power_word_fortitude,target=missing.fortitude.lowest,if=config.auto_fortitude&group.count(cycle.buff.power_word_fortitude.down)>0
    - penance,cycle=members,if=cycle.health.pct<config.ooc_penance_threshold&!player.combat&var.penance_ready
    - flash_heal,cycle=members,if=cycle.health.pct<config.ooc_flash_heal_threshold&!player.combat&var.surge_of_light_active
    - flash_heal,cycle=members,if=cycle.health.pct<config.ooc_flash_heal_threshold&!player.combat

  pain_suppression_logic:

    - pain_suppression,cycle=tanks,if=config.pain_suppression_usage>=1&cycle.health.pct<config.pain_suppression_threshold&cycle.buff.pain_suppression.down
    - pain_suppression,cycle=healers,if=config.pain_suppression_usage>=2&cycle.health.pct<config.pain_suppression_threshold&cycle.buff.pain_suppression.down
    - pain_suppression,cycle=members,if=config.pain_suppression_usage=3&cycle.health.pct<config.pain_suppression_threshold&cycle.buff.pain_suppression.down

  major_cooldowns:

    - evangelism,if=group.count(cycle.health.pct<80)>=config.evangelism_members
    - power_infusion,cycle=dps,if=config.auto_pi&(buff.bloodlust.up|var.evangelism_window)
    - shadowfiend,if=config.shadowfiend_usage!=0&((config.shadowfiend_usage=1)|(config.shadowfiend_usage=2&group.count(cycle.health.pct<80)>=2)|(config.shadowfiend_usage=3&group.count(cycle.health.pct<70)>=3))
    - power_word_barrier,if=group.count(cycle.health.pct<60)>=config.power_word_barrier_members
    - ultimate_penitence,if=group.count(cycle.health.pct<60)>=config.ultimate_penitence_members

  high_priority_healing:

    - desperate_prayer,if=health.pct<config.desperate_prayer_threshold
    - power_word_shield.player,if=health.pct<50&buff.power_word_shield.down
    - fade,if=target.threat>=3|config.auto_fade
    - penance.player,if=health.pct<45&var.penance_ready
    - penance,cycle=members,if=cycle.health.pct<55&var.penance_ready
    - flash_heal,cycle=members,if=cycle.health.pct<config.flash_heal_threshold&var.surge_of_light_active
    - power_word_shield,cycle=members,if=cycle.health.pct<40&!var.penance_ready&!var.surge_of_light_active&cycle.buff.power_word_shield.down
    - flash_heal.player,if=health.pct<30
    - flash_heal,cycle=members,if=cycle.health.pct<30

  dispel:

    - purify,cycle=members,if=cycle.dispelable.magic
    - purify,cycle=members,if=cycle.dispelable.disease
    - purify.player,if=player.dispelable

  evangelism_burst:
  
    - power_word_radiance,if=var.evangelism_window&group.count(cycle.health.pct<90)>=2
    - power_word_radiance,if=var.evangelism_window&cooldown.power_word_radiance.charges>=1&group.count(cycle.health.pct<75)>=2
    - penance,if=var.evangelism_window&var.penance_ready
    - mind_blast,if=var.evangelism_window

  penance_shield_combo:

    - power_word_shield,cycle=members,if=var.weal_and_woe_ready&cycle.health.pct<config.pws_hp_threshold&cycle.buff.atonement.up&cycle.buff.power_word_shield.down
    - power_word_shield,target=lowest,if=var.weal_and_woe_ready&group.lowest.health.pct<config.pws_hp_threshold&group.lowest.buff.remains(power_word_shield)=0

  atonement_spread:

    - power_word_radiance,if=group.count(cycle.health.pct<85)>=config.radiance_members
    - penance,cycle=members,if=cycle.buff.atonement.down&var.penance_ready
    - power_word_shield,cycle=members,if=cycle.buff.power_word_shield.down&cycle.buff.atonement.down
    - flash_heal,cycle=members,if=cycle.buff.atonement.down&var.surge_of_light_active
    - plea,cycle=members,if=cycle.buff.atonement.down

  offensive:

    - interrupt_self,if=player.casting&group.count(cycle.health.pct<50)>=1&(var.penance_ready|var.surge_of_light_active)
    - shadow_word_pain,if=config.maintain_dot&debuff.shadow_word_pain.remains<3
    - mind_blast
    - penance,if=var.power_of_dark_side&var.penance_ready
    - penance,if=cooldown.penance.charges>=2
    - shadow_word_death,if=config.use_shadow_word_death&target.health.pct<=20
    - smite

  mouseover_friendly:

    - pain_suppression.mouseover,if=config.mo_pain_suppression&mouseover.health.pct<config.pain_suppression_threshold&mouseover.buff.remains(pain_suppression)=0
    - penance.mouseover,if=config.mo_penance&mouseover.health.pct<config.mo_penance_threshold&var.penance_ready
    - flash_heal.mouseover,if=config.mo_flash_heal&mouseover.health.pct<config.mo_flash_heal_threshold
    - purify.mouseover,if=config.mo_purify&mouseover.dispelable

  mouseover_enemy:
# ADD WHEN MOUSEOVERS WORK
  #  - shadow_word_pain.mouseover,if=config.mo_dot&mouseover.debuff.remains(shadow_word_pain)=0

  moving:

    - penance,cycle=members,if=cycle.health.pct<config.penance_healing_threshold&var.penance_ready
    - power_word_shield,cycle=members,if=var.weal_and_woe_ready&cycle.health.pct<config.pws_hp_threshold&cycle.buff.power_word_shield.down
    - power_word_shield,cycle=members,if=cycle.buff.power_word_shield.down&cycle.buff.atonement.down
    - power_word_shield,target=lowest,if=group.lowest.buff.remains(power_word_shield)=0
    - flash_heal,cycle=members,if=var.surge_of_light_active&cycle.health.pct<config.pws_hp_threshold
    - plea,cycle=members,if=cycle.buff.atonement.down&cycle.health.pct<90
    - shadow_word_pain,if=config.maintain_dot&debuff.shadow_word_pain.remains<5

  trinkets:
    - trinket_1,if=var.trinket1_living_silk&trinket_1.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&var.evangelism_window)|(config.trinket_usage=3&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members))
    - trinket_2,if=var.trinket2_living_silk&trinket_2.ready&config.trinket_usage!=0&((config.trinket_usage=1)|(config.trinket_usage=2&var.evangelism_window)|(config.trinket_usage=3&group.count(cycle.health.pct<config.living_silk_hp)>=config.living_silk_members))

    - trinket_1,if=!var.trinket1_living_silk&trinket_1.ready&config.trinket_usage=1
    - trinket_2,if=!var.trinket2_living_silk&trinket_2.ready&config.trinket_usage=1

  main:

    - call_action_list,name=spell_queue
    - call_action_list,name=sanity_checks
    - call_action_list,name=auto_target_ranged
    - call_action_list,name=out_of_combat,if=!player.combat
    - angelic_feather.player,if=var.use_feather&config.angelic_feather_usage!=0
    - shadow_word_pain.mouseover,if=config.mo_dot&var.mo_enemy_valid&mouseover.debuff.remains(shadow_word_pain)=0
    - return,if=!player.combat
    - return,if=player.channeling
    - call_action_list,name=interrupts
    - call_action_list,name=pain_suppression_logic
    - call_action_list,name=major_cooldowns
    - call_action_list,name=high_priority_healing
    - call_action_list,name=dispel
    - call_action_list,name=evangelism_burst,if=var.evangelism_window
    - call_action_list,name=penance_shield_combo,if=var.weal_and_woe_ready
    - call_action_list,name=moving,if=player.moving
    - call_action_list,name=mouseover_friendly,if=config.mouseover_enabled&var.mo_friendly_valid&!player.casting&!player.channeling
    - call_action_list,name=mouseover_enemy,if=config.mouseover_enabled&var.mo_enemy_valid&!player.casting&!player.channeling
    - call_action_list,name=trinkets
    - call_action_list,name=atonement_spread,if=group.count(cycle.health.pct<90)>=2|group.count(cycle.buff.atonement.down)>=2
    - call_action_list,name=offensive,if=target.valid