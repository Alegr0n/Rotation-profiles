version: 1.2
author: Alegr0n
spec: 65
name: Holy
description: |
  Holy Paladin rotation for Midnight Pre-Patch.
  Optimized for M+ dungeons.
entry: main

morphs:
  word_of_glory: eternal_flame

config:

  lay_on_hands_threshold:
    label: "Lay on Hands HP %"
    type: slider
    min: 10
    max: 35
    default: 25

  divine_protection_threshold:
    label: "Divine Protection HP %"
    type: slider
    min: 30
    max: 60
    default: 45

  blessing_of_sacrifice_threshold:
    label: "Blessing of Sacrifice HP %"
    type: slider
    min: 20
    max: 50
    default: 35

  divine_shield_threshold:
    label: "Divine Shield HP %"
    type: slider
    min: 10
    max: 30
    default: 15

  avenging_wrath_members:
    label: "Avenging Wrath - 70%"
    type: slider
    min: 1
    max: 5
    default: 2

  aura_mastery_members:
    label: "Aura Mastery - 75%"
    type: slider
    min: 2
    max: 5
    default: 3

  divine_toll_members:
    label: "Divine Toll - 90%"
    type: slider
    min: 1
    max: 5
    default: 2

  beacon_of_virtue_members:
    label: "Beacon of Virtue - 85%"
    type: slider
    min: 2
    max: 5
    default: 3

  auto_beacon_of_light:
    label: "Beacon of Light (Tank)"
    type: checkbox
    default: true

  auto_beacon_of_faith:
    label: "Beacon of Faith (DPS)"
    type: checkbox
    default: true

  light_of_dawn_members:
    label: "Light of Dawn - 85%"
    type: slider
    min: 3
    max: 5
    default: 3

  word_of_glory_threshold:
    label: "Word of Glory HP %"
    type: slider
    min: 60
    max: 90
    default: 75

  holy_shock_healing_threshold:
    label: "Holy Shock Healing HP %"
    type: slider
    min: 70
    max: 95
    default: 85

  flash_of_light_threshold:
    label: "Flash of Light HP %"
    type: slider
    min: 50
    max: 80
    default: 65

  holy_light_threshold:
    label: "Holy Light HP %"
    type: slider
    min: 60
    max: 90
    default: 80

  mouseover_enabled:
    label: "Enable Mouseover Healing"
    type: checkbox
    default: true

  mo_lay_on_hands:
    label: "MO: Lay on Hands"
    type: checkbox
    default: true

  mo_word_of_glory:
    label: "MO: Word of Glory"
    type: checkbox
    default: true

  mo_holy_shock:
    label: "MO: Holy Shock"
    type: checkbox
    default: true

  mo_flash_of_light:
    label: "MO: Flash of Light"
    type: checkbox
    default: true

  auto_blessing_of_freedom:
    label: "Auto Blessing of Freedom"
    type: checkbox
    default: true

  auto_cleanse:
    label: "Auto Cleanse (Dispel)"
    type: checkbox
    default: true

  use_hammer_of_wrath:
    label: "Use Hammer of Wrath"
    type: checkbox
    default: true

  auto_interrupt:
    label: "Auto Interrupt"
    type: checkbox
    default: true

  use_blinding_light:
    label: "Use Blinding Light"
    type: checkbox
    default: true

variables:

  hp_capped: holy_power>=5
  hp_spendable: holy_power>=3|buff.divine_purpose.up
  hp_deficit_ok: holy_power.deficit>=3

  infusion_of_light: buff.infusion_of_light.up
  divine_purpose: buff.divine_purpose.up
  avenging_wrath_active: buff.avenging_wrath.up|buff.avenging_crusader.up
  beacon_of_virtue_active: buff.beacon_of_virtue.up

  suns_avatar_active: buff.suns_avatar.up
  tyrs_deliverance_active: buff.tyrs_deliverance.up
  divine_favor_active: buff.divine_favor.up
  sun_sear_active: buff.sun_sear.up

  holy_shock_ready: cooldown.holy_shock.charges>=1
  divine_toll_ready: cooldown.divine_toll.ready
  avenging_wrath_ready: cooldown.avenging_wrath.ready

  group_needs_healing: group.count(cycle.health.pct<85)>=2
  group_emergency: group.count(cycle.health.pct<50)>=2
  group_critical: group.count(cycle.health.pct<30)>=1

  mo_friendly_valid: mouseover.exists&mouseover.alive&!mouseover.enemy
  mo_enemy_valid: mouseover.exists&mouseover.alive&mouseover.enemy

  racial_defensive_hp: 50
  racial_emergency_hp: 35
  racial_heal_ally_hp: 60

  trinket1_living_silk: trinket_1.id=242393
  trinket2_living_silk: trinket_2.id=242393
  has_living_silk: var.trinket1_living_silk|var.trinket2_living_silk

lists:

  spell_queue:
    - queue_spell

  sanity_checks:
    - return,if=player.dead
    - return,if=mounted
    - return,if=!state.rotation
    - return,if=state.blocked_inputs

  interrupts:

    - hammer_of_justice,if=config.auto_interrupt&interrupts.target.stun.ready&target.casting.elapsed>=0.2
    - hammer_of_justice.mouseover,if=config.auto_interrupt&interrupts.mouseover.stun.ready&mouseover.casting.elapsed>=0.2
    - hammer_of_justice.focus,if=config.auto_interrupt&interrupts.focus.stun.ready&focus.casting.elapsed>=0.2
    - blinding_light,if=config.use_blinding_light&(interrupts.8y.count>=2|interrupts.8y.stun.count>=2)

  out_of_combat:

    - devotion_aura,if=buff.devotion_aura.down
    - beacon_of_light,cycle=tanks,if=config.auto_beacon_of_light&cycle.buff.beacon_of_light.down
    - beacon_of_faith,cycle=dps,if=config.auto_beacon_of_faith&cycle.buff.beacon_of_faith.down
    - redemption,cycle=members,if=cycle.dead
    - word_of_glory,cycle=members,if=var.hp_spendable&cycle.health.pct<70
    - holy_shock,cycle=members,if=cycle.health.pct<80&var.holy_shock_ready
    - flash_of_light,cycle=members,if=cycle.health.pct<60

  emergency:

    - divine_shield,if=health.pct<config.divine_shield_threshold
    - lay_on_hands.player,if=health.pct<config.lay_on_hands_threshold
    - lay_on_hands,cycle=tanks,if=cycle.health.pct<config.lay_on_hands_threshold
    - lay_on_hands,cycle=members,if=cycle.health.pct<config.lay_on_hands_threshold
    - divine_protection,if=health.pct<config.divine_protection_threshold
    - blessing_of_sacrifice,cycle=tanks,if=cycle.health.pct<config.blessing_of_sacrifice_threshold&health.pct>40
    - holy_shock.player,if=health.pct<50&var.holy_shock_ready
    - word_of_glory.player,if=health.pct<50&var.hp_spendable
    - flash_of_light.player,if=health.pct<40&var.infusion_of_light
    - flash_of_light.player,if=health.pct<35

  major_cooldowns:

    - aura_mastery,if=group.count(cycle.health.pct<75)>=config.aura_mastery_members|group.count(cycle.health.pct<=55)>=2
    - avenging_wrath,if=group.count(cycle.health.pct<70)>=config.avenging_wrath_members
    - avenging_crusader,if=group.count(cycle.health.pct<70)>=config.avenging_wrath_members
    - beacon_of_virtue,if=group.count(cycle.health.pct<85)>=config.beacon_of_virtue_members&var.hp_spendable&var.avenging_wrath_active
    - beacon_of_virtue,if=group.count(cycle.health.pct<70)>=2&var.hp_spendable
    - divine_toll,if=group.count(cycle.health.pct<90)>=config.divine_toll_members&var.hp_deficit_ok&var.avenging_wrath_active
    - divine_toll,if=group.count(cycle.health.pct<80)>=2&var.hp_deficit_ok
    - holy_prism,if=cooldown.holy_prism.ready&var.hp_deficit_ok

  virtue_window:

    - word_of_glory,cycle=members,if=var.hp_spendable&cycle.health.pct<85
    - holy_shock,cycle=members,if=cycle.health.pct<config.holy_shock_healing_threshold&var.holy_shock_ready
    - judgment,if=holy_power.deficit>=1

  avenging_crusader_rotation:

    - judgment,if=holy_power.deficit>=1
    - hammer_of_wrath,if=config.use_hammer_of_wrath&holy_power.deficit>=1
    - shield_of_the_righteous,if=var.hp_capped

  spenders:

    # Sun Sear priority - spend HP quickly after Divine Toll to apply Dawnlight
    - light_of_dawn,if=var.sun_sear_active&var.hp_spendable&group.count(cycle.health.pct<90)>=2
    - word_of_glory,cycle=members,if=var.sun_sear_active&var.hp_spendable&cycle.health.pct<85
    # Sun's Avatar priority
    - light_of_dawn,if=var.suns_avatar_active&var.hp_spendable&group.count(cycle.health.pct<90)>=2
    - word_of_glory,cycle=members,if=var.suns_avatar_active&var.hp_spendable&cycle.health.pct<85
    - light_of_dawn,if=var.hp_capped&group.count(cycle.health.pct<90)>=2
    - word_of_glory,cycle=members,if=var.hp_capped&cycle.health.pct<90
    - shield_of_the_righteous,if=var.hp_capped
    - light_of_dawn,if=!var.beacon_of_virtue_active&group.count(cycle.health.pct<85)>=config.light_of_dawn_members&var.hp_spendable
    - word_of_glory,cycle=members,if=var.hp_spendable&cycle.health.pct<config.word_of_glory_threshold
    - word_of_glory.player,if=var.hp_spendable&health.pct<config.word_of_glory_threshold
    - shield_of_the_righteous,if=var.hp_spendable&!var.group_needs_healing

  dawnlight_maintenance:

    - holy_prism,if=cooldown.holy_prism.ready

  generators:

    - holy_shock,cycle=members,if=var.tyrs_deliverance_active&cycle.health.pct<90&var.holy_shock_ready
    - flash_of_light,cycle=members,if=var.tyrs_deliverance_active&cycle.health.pct<80
    - holy_light,cycle=members,if=var.divine_favor_active&var.infusion_of_light&cycle.health.pct<90
    - judgment,if=var.infusion_of_light&holy_power.deficit>=1
    - hammer_of_wrath,if=var.infusion_of_light&config.use_hammer_of_wrath&holy_power.deficit>=1
    - holy_shock,cycle=members,if=cycle.health.pct<config.holy_shock_healing_threshold&var.holy_shock_ready
    - holy_shock,if=var.holy_shock_ready&!var.group_needs_healing
    - flash_of_light,cycle=members,if=var.infusion_of_light&cycle.health.pct<config.flash_of_light_threshold
    - judgment,if=holy_power.deficit>=1
    - hammer_of_wrath,if=config.use_hammer_of_wrath&holy_power.deficit>=1
    - holy_light,cycle=members,if=var.infusion_of_light&cycle.health.pct<config.holy_light_threshold
    - flash_of_light,cycle=members,if=cycle.health.pct<45
    - consecration,if=!buff.consecration.up

  mouseover_friendly:

    - intercession.mouseover,if=mouseover.dead&health.pct>20
    - lay_on_hands.mouseover,if=config.mo_lay_on_hands&mouseover.health.pct<config.lay_on_hands_threshold
    - word_of_glory.mouseover,if=config.mo_word_of_glory&mouseover.health.pct<config.word_of_glory_threshold&var.hp_spendable
    - holy_shock.mouseover,if=config.mo_holy_shock&mouseover.health.pct<config.holy_shock_healing_threshold&var.holy_shock_ready
    - flash_of_light.mouseover,if=config.mo_flash_of_light&mouseover.health.pct<config.flash_of_light_threshold

  mouseover_enemy:

    - judgment.mouseover,if=holy_power.deficit>=1
    - hammer_of_wrath.mouseover,if=config.use_hammer_of_wrath&holy_power.deficit>=1&mouseover.health.pct<20

  beacon_maintenance:

    - beacon_of_light,cycle=tanks,if=config.auto_beacon_of_light&cycle.buff.beacon_of_light.down
    - beacon_of_faith,cycle=dps,if=config.auto_beacon_of_faith&cycle.buff.beacon_of_faith.down

  utility:

    - cleanse,cycle=members,if=config.auto_cleanse&cycle.dispelable.list
    - cleanse.player,if=config.auto_cleanse&player.dispelable.list
    - blessing_of_freedom,cycle=members,if=config.auto_blessing_of_freedom&cycle.debuff.snare.up

  trinkets:

    - trinket_1,if=var.trinket1_living_silk&trinket_1.ready&(var.avenging_wrath_active|var.group_emergency)
    - trinket_2,if=var.trinket2_living_silk&trinket_2.ready&(var.avenging_wrath_active|var.group_emergency)
    - trinket_1,if=!var.trinket1_living_silk&trinket_1.ready&(var.avenging_wrath_active|var.group_emergency)
    - trinket_2,if=!var.trinket2_living_silk&trinket_2.ready&(var.avenging_wrath_active|var.group_emergency)

  moving:

    - holy_shock,cycle=members,if=cycle.health.pct<config.holy_shock_healing_threshold&var.holy_shock_ready
    - word_of_glory,cycle=members,if=var.hp_spendable&cycle.health.pct<config.word_of_glory_threshold
    - light_of_dawn,if=group.count(cycle.health.pct<85)>=config.light_of_dawn_members&var.hp_spendable
    - judgment,if=holy_power.deficit>=1
    - hammer_of_wrath,if=config.use_hammer_of_wrath&holy_power.deficit>=1

  racial_defensive:

    - stoneform,if=player.dispelable.list
    - fireblood,if=player.dispelable.list
    - will_of_the_forsaken,if=player.feared|player.charmed
    - escape_artist,if=player.rooted
    - will_to_survive,if=player.stunned
    - gift_of_the_naaru.player,if=health.pct<var.racial_emergency_hp
    - regeneratin,if=health.pct<var.racial_emergency_hp&!player.combat
    - stoneform,if=health.pct<var.racial_defensive_hp
    - fireblood,if=health.pct<var.racial_defensive_hp

  racial_offensive:

    - berserking,if=var.avenging_wrath_active
    - blood_fury,if=var.avenging_wrath_active
    - ancestral_call,if=var.avenging_wrath_active
    - fireblood,if=var.avenging_wrath_active&!player.dispelable.list
    - azerite_surge,if=var.avenging_wrath_active

  racial_cc:

    - war_stomp,if=interrupts.8y.stun.count>=1
    - quaking_palm,if=target.casting.interruptible
    - haymaker,if=target.casting.interruptible
    - bull_rush,if=target.casting.interruptible
    - wing_buffet,if=target.casting.interruptible
    - arcane_pulse,if=enemies.8y.count>=3

  racial_utility:

    - arcane_torrent,if=mana.pct<=90
    - gift_of_the_naaru,target=lowest,if=group.lowest.health.pct<var.racial_heal_ally_hp
    - bag_of_tricks,target=lowest,if=group.lowest.health.pct<var.racial_heal_ally_hp
    - shadowmeld,if=target.threat>=3&!player.casting
    - holo,if=health.pct<30

  main:

    - call_action_list,name=spell_queue
    - call_action_list,name=sanity_checks
    - call_action_list,name=auto_target
    - call_action_list,name=out_of_combat
    - return,if=!player.combat
    - return,if=player.channeling
    - call_action_list,name=emergency
    - call_action_list,name=racial_defensive
    - call_action_list,name=interrupts
    - call_action_list,name=racial_cc
    - call_action_list,name=utility
    - call_action_list,name=beacon_maintenance
    - call_action_list,name=major_cooldowns
    - call_action_list,name=racial_offensive,if=var.avenging_wrath_active
    - call_action_list,name=virtue_window,if=var.beacon_of_virtue_active
    - call_action_list,name=avenging_crusader_rotation,if=buff.avenging_crusader.up
    - call_action_list,name=moving,if=player.moving
    - call_action_list,name=mouseover_friendly,if=config.mouseover_enabled&var.mo_friendly_valid&!player.casting
    - call_action_list,name=mouseover_enemy,if=config.mouseover_enabled&var.mo_enemy_valid&!player.casting
    - call_action_list,name=racial_utility
    - call_action_list,name=trinkets
    - call_action_list,name=dawnlight_maintenance
    - call_action_list,name=spenders
    - call_action_list,name=generators